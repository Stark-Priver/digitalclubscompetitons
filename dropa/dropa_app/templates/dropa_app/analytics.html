{% extends 'dropa_app/base.html' %}
{% load static %}

{% block page_title %}Analytics{% endblock %}

{% block content %}
<div class="analytics-header">
    <div class="header-left">
        <h2>Analytics Dashboard</h2>
        <p>Comprehensive delivery performance insights</p>
    </div>
    <div class="header-actions">
        <select id="timeRangeSelector" class="time-selector">
            <option value="today">Today</option>
            <option value="week">This Week</option>
            <option value="month" selected>This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
        </select>
        <button class="btn btn-primary" onclick="exportReport()">
            <i class="fas fa-download"></i>
            Export Report
        </button>
    </div>
</div>

<div class="analytics-grid">
    <!-- Performance Metrics -->
    <div class="analytics-card full-width">
        <div class="card-header">
            <h3>Performance Overview</h3>
            <div class="performance-summary">
                <div class="metric">
                    <span class="metric-value">98.5%</span>
                    <span class="metric-label">Success Rate</span>
                </div>
                <div class="metric">
                    <span class="metric-value">2.3h</span>
                    <span class="metric-label">Avg Delivery Time</span>
                </div>
                <div class="metric">
                    <span class="metric-value">4.8</span>
                    <span class="metric-label">Customer Rating</span>
                </div>
            </div>
        </div>
        <div class="card-content">
            <canvas id="performanceChart" height="100"></canvas>
        </div>
    </div>

    <!-- Delivery Trends -->
    <div class="analytics-card">
        <div class="card-header">
            <h3>Delivery Trends</h3>
        </div>
        <div class="card-content">
            <canvas id="trendsChart" height="150"></canvas>
        </div>
    </div>

    <!-- Geographic Distribution -->
    <div class="analytics-card">
        <div class="card-header">
            <h3>Geographic Distribution</h3>
        </div>
        <div class="card-content">
            <div id="geoChart" class="geo-chart">
                <div class="geo-placeholder">
                    <i class="fas fa-map"></i>
                    <p>Geographic heat map</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Courier Performance -->
    <div class="analytics-card">
        <div class="card-header">
            <h3>Courier Performance</h3>
        </div>
        <div class="card-content">
            <div class="courier-ranking">
                <div class="ranking-item">
                    <div class="rank">1</div>
                    <div class="courier-info">
                        <span class="name">Michael Johnson</span>
                        <span class="score">127 deliveries</span>
                    </div>
                    <div class="rating">⭐ 4.9</div>
                </div>
                <div class="ranking-item">
                    <div class="rank">2</div>
                    <div class="courier-info">
                        <span class="name">Sarah Williams</span>
                        <span class="score">95 deliveries</span>
                    </div>
                    <div class="rating">⭐ 4.8</div>
                </div>
                <div class="ranking-item">
                    <div class="rank">3</div>
                    <div class="courier-info">
                        <span class="name">David Chen</span>
                        <span class="score">88 deliveries</span>
                    </div>
                    <div class="rating">⭐ 4.7</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Peak Hours -->
    <div class="analytics-card">
        <div class="card-header">
            <h3>Peak Hours Analysis</h3>
        </div>
        <div class="card-content">
            <canvas id="peakHoursChart" height="150"></canvas>
        </div>
    </div>

    <!-- Customer Satisfaction -->
    <div class="analytics-card">
        <div class="card-header">
            <h3>Customer Satisfaction</h3>
        </div>
        <div class="card-content">
            <div class="satisfaction-metrics">
                <div class="satisfaction-item">
                    <div class="rating-stars">
                        <span class="stars">⭐⭐⭐⭐⭐</span>
                        <span class="percentage">78%</span>
                    </div>
                </div>
                <div class="satisfaction-item">
                    <div class="rating-stars">
                        <span class="stars">⭐⭐⭐⭐</span>
                        <span class="percentage">15%</span>
                    </div>
                </div>
                <div class="satisfaction-item">
                    <div class="rating-stars">
                        <span class="stars">⭐⭐⭐</span>
                        <span class="percentage">5%</span>
                    </div>
                </div>
                <div class="satisfaction-item">
                    <div class="rating-stars">
                        <span class="stars">⭐⭐</span>
                        <span class="percentage">1.5%</span>
                    </div>
                </div>
                <div class="satisfaction-item">
                    <div class="rating-stars">
                        <span class="stars">⭐</span>
                        <span class="percentage">0.5%</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.analytics-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
}

.header-left h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.25rem;
}

.header-left p {
    color: #64748b;
    margin: 0;
}

.header-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.time-selector {
    padding: 0.5rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    font-size: 0.875rem;
    background: white;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}

.analytics-card {
    background: white;
    border-radius: 1rem;
    border: 1px solid #e2e8f0;
    overflow: hidden;
}

.analytics-card.full-width {
    grid-column: 1 / -1;
}

.card-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.card-header h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1e293b;
}

.performance-summary {
    display: flex;
    gap: 2rem;
}

.metric {
    text-align: center;
}

.metric-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: #3b82f6;
}

.metric-label {
    font-size: 0.875rem;
    color: #64748b;
}

.card-content {
    padding: 1.5rem;
}

.geo-chart {
    height: 300px;
    background: #f8fafc;
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    color: #94a3b8;
}

.geo-placeholder i {
    font-size: 3rem;
    margin-bottom: 0.5rem;
}

.courier-ranking {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.ranking-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 0.5rem;
}

.rank {
    width: 32px;
    height: 32px;
    background: #3b82f6;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
}

.courier-info {
    flex: 1;
    display: flex;
    flex-direction: column;
}

.courier-info .name {
    font-weight: 600;
    color: #1e293b;
}

.courier-info .score {
    font-size: 0.875rem;
    color: #64748b;
}

.rating {
    font-size: 0.875rem;
    color: #f59e0b;
}

.satisfaction-metrics {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.satisfaction-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.rating-stars {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stars {
    font-size: 0.875rem;
}

.percentage {
    font-weight: 600;
    color: #1e293b;
}

@media (max-width: 1200px) {
    .analytics-grid {
        grid-template-columns: 1fr;
    }
    
    .performance-summary {
        flex-direction: column;
        gap: 1rem;
    }
}

@media (max-width: 768px) {
    .analytics-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
    }
    
    .header-actions {
        width: 100%;
        justify-content: space-between;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    initializeAnalyticsCharts();
    setupTimeRangeSelector();
});

function initializeAnalyticsCharts() {
    initializePerformanceChart();
    initializeTrendsChart();
    initializePeakHoursChart();
}

function initializePerformanceChart() {
    const ctx = document.getElementById('performanceChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Deliveries',
                data: [1200, 1400, 1100, 1600, 1800, 1500],
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                tension: 0.4
            }, {
                label: 'Success Rate (%)',
                data: [95, 97, 94, 98, 99, 98.5],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                fill: true,
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });
}

function initializeTrendsChart() {
    const ctx = document.getElementById('trendsChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
                label: 'Packages',
                data: [180, 195, 220, 210, 240, 160, 120],
                backgroundColor: '#3b82f6',
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function initializePeakHoursChart() {
    const ctx = document.getElementById('peakHoursChart');
    if (!ctx) return;

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Morning', 'Afternoon', 'Evening', 'Night'],
            datasets: [{
                data: [30, 45, 20, 5],
                backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#8b5cf6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function setupTimeRangeSelector() {
    const selector = document.getElementById('timeRangeSelector');
    selector.addEventListener('change', function() {
        updateAnalytics(this.value);
    });
}

function updateAnalytics(timeRange) {
    console.log('Updating analytics for:', timeRange);
    // Implement analytics update based on time range
    showNotification(`Analytics updated for ${timeRange}`, 'info');
}

function exportReport() {
    console.log('Exporting analytics report');
    showNotification('Generating analytics report...', 'info');
    
    setTimeout(() => {
        showNotification('Report exported successfully!', 'success');
    }, 2000);
}
</script>
{% endblock %}
